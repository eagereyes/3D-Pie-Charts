<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>3D Pies!</title>
		 <link href="css/bootstrap.min.css" rel="stylesheet">
		<script src="js/d3.min.js" charset="utf-8"></script>
		<script src="js/numbers.min.js"></script>
		<style>
			.grayslice {
				fill: lightgray;
			}
			
			.body {
				fill: darkgray;
			}
			
			.bluebody {
				fill: #005480;
			}
			
			.blueslice {
				fill: steelblue
			}
			
			.blue {
				font-weight: bold;
				color: steelblue;
			}
			
			#demographics, #infoPanel, #studyPanel, #question, #thankyou,
			#cond2, #cond2question, #pie, #break, #cond2Wrong, #cond2Correct {
				display: none;
			}
						
			#topSpacing {
				margin-top: 40px;
			}
			
			.error {
				padding: 15px;
				font-weight: bold;
				display: none;
			}
			
			.progressbox {
				width: 8px;
				height: 8px;
				margin-right: 1px;
				background-color: lightgray;
				display: inline-block;
			}
			
			.complete {
				background-color: darkgray;
			}
			
			#errors {
				margin-top: 520px;
			}
			
			/* hide spinner in input box */
			input[type="number"]::-webkit-outer-spin-button,
			input[type="number"]::-webkit-inner-spin-button {
				-webkit-appearance: none;
				margin: 0;
			}
			input[type="number"] {
				-moz-appearance: textfield;
			}
		</style>
	</head>
	<body>
		<div class="row" id="topSpacing">
		</div>
		<div class="row" id="instructions">
			<div class="col-md-6 col-md-offset-1">
				<h1>Pie Charts Study</h1>
				<p>This study examines how well people can read different pie charts.
					Your task is to read values from a series of charts	and enter them into a numeric input field.</p>
				<div id="cond2">
					<p><strong>Here's how to read these charts: Look at how much area is blue compared to the entire chart.
						3D pie charts distort the angle of the slice, but not the area as a fraction of the whole! Your accuracy will be much higher if you go by area rather than by angle.</strong></p>
				</div>
				<p>Please answer as accurately as possible. If your accuracy is considerably worse than the average, we will not be able to use the data and won't approve the HIT.</p>
				<p>The complete study should take about 15-20 minutes. You will be given a chance to rest after one third and two thirds of the questions.</p>
				<p>At the very end, you will see a code. Please copy and paste that code into the input field on the Mechanical Turk website.</p>
				<p>We really appreciate your help with this study. Thank you!</p>
				<p>&nbsp;</p>
				<button class="btn btn-primary pull-right" type="button" onclick="showDemographics();">Let's Go!</button>
			</div>
		</div>
		<div class="row" id="demographics">
			<div class="col-md-6 col-md-offset-1">
				<h1>Brief Demographic Survey</h1>
				<p>Please answer the following questions. Your responses are only used to report summary statistics.
				<div id="age"><strong>Your age:</strong>
					<div id="ages">
						<input type="radio" id="a1" name="age" value="18-24"> 18-24 &nbsp;&nbsp;&nbsp;
						<input type="radio" id="a2" name="age" value="25-29"> 25-29 &nbsp;&nbsp;&nbsp;
						<input type="radio" id="a2" name="age" value="30-39"> 30-39 &nbsp;&nbsp;&nbsp;
						<input type="radio" id="a3" name="age" value="40-49"> 40-49 &nbsp;&nbsp;&nbsp;
						<input type="radio" id="a4" name="age" value="50-59"> 50-59 &nbsp;&nbsp;&nbsp;
						<input type="radio" id="a5" name="age" value="60+"> 60+ &nbsp;&nbsp;&nbsp;
						<input type="radio" id="a6" name="age" value="Unspecified"> Unspecified
					</div>
				</div>
				<br>
				<div id="sex"><strong>Your gender:</strong>
					<div id="sexes">
						<input type="radio" id="s1" name="sex" value="Male"> Male &nbsp;&nbsp;&nbsp;
						<input type="radio" id="s2" name="sex" value="Female"> Female &nbsp;&nbsp;&nbsp;
						<input type="radio" id="s3" name="sex" value="Unspecified"> Unspecified
					</div>
				</div>
				<br>
				<div id="degree"><strong>Highest degree obtained:</strong>
					<div id="degrees">
						<input type="radio" id="d1" name="degree" value="High School"> High School &nbsp;&nbsp;&nbsp;
						<input type="radio" id="d2" name="degree" value="Bachelors"> Bachelors &nbsp;&nbsp;&nbsp;
						<input type="radio" id="d3" name="degree" value="Masters"> Masters &nbsp;&nbsp;&nbsp;
						<input type="radio" id="d4" name="degree" value="PhD"> PhD &nbsp;&nbsp;&nbsp;
						<input type="radio" id="d5" name="degree" value="Other"> Other
					</div>
				</div>

				<button class="btn btn-primary pull-right" type="button" id="doneDemographics" disabled="disabled" onclick="potentialNagScreen();">Start Study</button>
			</div>
		</div>
		<div class="row" id="cond2question">
			<div class="col-md-6 col-md-offset-1">
				<h1>How are you supposed to read the charts?</h1>
				<div class="radio"><label><input type="radio" name="how" value="angle"> Angle</label></div>
				<div class="radio"><label><input type="radio" name="how" value="area"> Area</label></div>
				<div class="radio"><label><input type="radio" name="how" value="arc"> Arc Length</label></div>
				<p class="bg-danger error" id="cond2Wrong">Wrong! Please try again!</p>
				<p class="bg-success error" id="cond2Correct">Correct! Area as a fraction of the entire chart does not change when the chart is projected into 3D.</p><br/>
				<button class="btn btn-primary pull-right" id="cond2Start" type="button" disabled="disabled" onclick="startStudy();">Start Study</button></p>
			</div>
		</div>
		<div class="row">
			<div class="col-md-8 col-md-offset-1" id="question">
				<h4>What part of the whole (in percent) does the <span class="blue">blue slice</span> represent?</h4>
			</div>
		</div>
		<div class="row">
			<div class="col-md-8" id="pie">
			</div>
			<div class="col-md-offset-1 col-md-8" id="break">
				<h1>Break Time!</h1>
				<p>Please take a brief break to rest your eyes before you continue.</p>
				<p>&nbsp;</p>
				<button class="btn btn-primary pull-right" type="button" onclick="endBreak();">Continue</button>
			</div>
			<div class="col-md-8 col-md-offset-1" id="thankyou">
				<h1>Thank you!</h1>
				<p>Thank you for completing the study! Please paste this code into the text field on Mechnical Turk:</p>
				<h2 id="code"></h2>
			</div>
			<div class="col-md-4">
				<div id="infoPanel">
					<label>Central Angle: <span id="centralAngleVal"></span>&deg; <input type="range" min="1" max="359" value="30" id="centralAngle" oninput="redraw();"></label><br/>
					<label>View Angle: <span id="viewAngleVal"></span>&deg; <input type="range" min="15" max="90" value="15" id="viewAngle" oninput="redraw();"></label><br/>
					<label>Rotation: <span id="rotationVal"></span>&deg; <input type="range" min="0" max="359" value="220" id="rotation" oninput="redraw();"></label><br />
					<label>Body: <span id="bodyVal"></span><input type="range" min="0" max="50" step="5" value="20" id="bodyHeight" oninput="redraw();"></label><br />
					
					Angle: <span id="angle"></span>&deg;<br/>
					Projected: <span id="distortedAngle"></span>&deg;<br />
					By Arc Length: <span id="angleByArc"></span>&deg;<br />
					By Area: <span id="angleByArea"></span>&deg;<br />
				</div>
				
				<div id="errors">
					<p class="bg-danger error" id="outofrange">Please respond in percent (1-99)! Try again.</p>
					<p class="bg-danger error" id="wrongpart">Please respond for the blue part of the pie! Try again.</p>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-offset-8 col-md-4" id="studyPanel">
				<label>Value: <input type="number" id="percent" onchange="nextStep();" min="1" max="99">%</label>
			</div>
		</div>
		<div class="row">
			<div class="col-md-offset-1 col-md-11" id="progressbar">
			</div>
		</div>

		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="js/jquery-1.12.0.min.js"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src="js/bootstrap.min.js"></script>
		<script src="threedeepies.js"></script>
		<script src="piestudy.js"></script>
		<script>
			var drawInfo = init();
			
			var trials;
			
			function rad(degrees) {
				return degrees*Math.PI/180;
			}
			
			function deg(radians) {
				return radians/Math.PI*180;
			}
						
			function redraw() {

				var centralAngle = $('#centralAngle')[0].value;
				$('#centralAngleVal').text(centralAngle);
				
				var viewAngle = $('#viewAngle')[0].value;
				$('#viewAngleVal').text(viewAngle);
				
				var rotation = $('#rotation')[0].value;
				$('#rotationVal').text(rotation);
				
				var bodyHeight = +$('#bodyHeight')[0].value;
				$('#bodyVal').text(bodyHeight);
				
				draw3DPie(drawInfo, rad(centralAngle), rad(viewAngle), rad(rotation), HEIGHT/2, bodyHeight);
				
				var predictions = predict(rad(centralAngle), rad(viewAngle), rad(rotation));
				
				$('#angle').text(deg(predictions.angle).toFixed(0));
				$('#distortedAngle').text(deg(predictions.angleDistorted).toFixed(0));
				$('#angleByArc').text(deg(predictions.angleByArc).toFixed(0));
				$('#angleByArea').text(deg(predictions.angleByArea).toFixed(0));
			}

			function validateDemographics() {
				if (demographics.age && demographics.sex && demographics.degree) {
					trials = makeTrials(resultID, window.location.hash.substr(1), demographics);
					$('#doneDemographics').prop('disabled', false);
				}
			}

			function validateHow(answer) {
				if (answer === 'area') {
					$('#cond2Wrong').hide();
					$('#cond2Correct').show();
					$('#cond2Start').prop('disabled', false);
				} else {
					$('#cond2Wrong').show();
					$('#cond2Correct').hide();
					$('#cond2Start').prop('disabled', true);					
				}
			}

			function potentialNagScreen() {
				if (window.location.hash === '#cond2') {
					$('#demographics').hide();
					$('#cond2question').show();
				} else {
					startStudy();
				}
			}

			if (window.location.hash === '#panel') {
				$('#infoPanel').show();
				$('#pie').show();
				$('#instructions').hide();

				redraw();
			} else {
				
				if (window.location.hash === '#cond2')
					$('#cond2').show();
				
				var d = ''+(new Date()).getTime();
				var s = '000000' + Math.floor(Math.random()*1000000);
				var resultID = d + 'x' + s.substr(s.length-6);

				$('#code').text(resultID);
				
				var demographics = {};
				
				d3.selectAll('input')
					.filter(function(d) { return this.name === 'age' ? this : null; })
					.on('change', function() { demographics.age = this.value; validateDemographics(); });

				d3.selectAll('input')
					.filter(function(d) { return this.name === 'sex' ? this : null; })
					.on('change', function() { demographics.sex = this.value; validateDemographics(); });

				d3.selectAll('input')
					.filter(function(d) { return this.name === 'degree' ? this : null; })
					.on('change', function() { demographics.degree = this.value; validateDemographics(); });
				
				d3.selectAll('input')
					.filter(function(d) { return this.name === 'how' ? this : null; })
					.on('change', function() { validateHow(this.value); });			
			}
			
		</script>
	</body>
</html>